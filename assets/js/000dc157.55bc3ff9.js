"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[97296],{13686:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>i,toc:()=>l});var o=t(85893),r=t(11151);const s={},a="Running Multiple Instances",i={id:"deploy/deploy-rocket.chat/scaling-rocket.chat/running-multiple-instances",title:"Running Multiple Instances",description:"While it's possible to scale up by adding more servers (recommended for HA purposes), you can better utilize your existing hardware by running multiple instances of the Rocket.Chat application (Node.js/Meteor app) on your current host(s). You should only do this if you already use a multi-core computer. A reasonable rule of thumb may be to run N-1 Rocket.Chat instances, where N=num_cores. Running multiple instances of Rocket.Chat on a single host requires a reverse proxy before your application. This tutorial assumes you've already followed the instructions for running behind an Nginx SSL Reverse Proxy.",source:"@site/docs/deploy/deploy-rocket.chat/scaling-rocket.chat/running-multiple-instances.md",sourceDirName:"deploy/deploy-rocket.chat/scaling-rocket.chat",slug:"/deploy/deploy-rocket.chat/scaling-rocket.chat/running-multiple-instances",permalink:"/docs-exp/docs/deploy/deploy-rocket.chat/scaling-rocket.chat/running-multiple-instances",draft:!1,unlisted:!1,editUrl:"https://github.com/Freedom101/docs-exp/tree/main/my-website/docs/deploy/deploy-rocket.chat/scaling-rocket.chat/running-multiple-instances.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Microservices",permalink:"/docs-exp/docs/deploy/deploy-rocket.chat/scaling-rocket.chat/microservices"},next:{title:"System Requirements",permalink:"/docs-exp/docs/deploy/deploy-rocket.chat/system-requirements"}},c={},l=[{value:"Run multiple instances of Rocket.Chat",id:"run-multiple-instances-of-rocketchat",level:2},{value:"Ensure nodes can communicate",id:"ensure-nodes-can-communicate",level:3},{value:"Update your Nginx proxy config",id:"update-your-nginx-proxy-config",level:2},{value:"Update your Apache proxy config",id:"update-your-apache-proxy-config",level:2},{value:"Check your database",id:"check-your-database",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h1,{id:"running-multiple-instances",children:"Running Multiple Instances"}),"\n",(0,o.jsxs)("figure",{children:[(0,o.jsx)("img",{src:"/img/2021-06-10_22-31-38 (3) (3) (3) (3) (3) (3) (3) (3) (3) (2) (3) (1) (1) (1) (1) (2) (1) (1) (1) (1) (1) (1) (4) (1) (1) (1) (1) (1) (1) (1) (34).jpg",alt:""}),(0,o.jsx)("figcaption",{})]}),"\n",(0,o.jsxs)(n.p,{children:["While it's possible to scale up by adding more servers (recommended for HA purposes), you can better utilize your existing hardware by running multiple instances of the Rocket.Chat application (Node.js/Meteor app) on your current host(s). You should only do this if you already use a multi-core computer. A reasonable rule of thumb may be to run ",(0,o.jsx)(n.code,{children:"N-1"})," Rocket.Chat instances, where ",(0,o.jsx)(n.code,{children:"N=num_cores"}),". Running multiple instances of Rocket.Chat on a single host requires a reverse proxy before your application. This tutorial assumes you've already followed the instructions for ",(0,o.jsx)(n.a,{href:"/docs-exp/docs/setup-and-configure/environment-configuration/configuring-ssl-reverse-proxy",children:"running behind an Nginx SSL Reverse Proxy"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"Essentially, there are just three steps:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"https://docs.mongodb.com/manual/tutorial/deploy-replica-set/",children:"Enable ReplicaSet on your MongoDB installation"}),"."]}),"\n",(0,o.jsx)(n.li,{children:"Start multiple instances of Rocket.Chat bound to different ports."}),"\n",(0,o.jsx)(n.li,{children:"Update your proxy to point at all local Rocket.Chat instances."}),"\n"]}),"\n",(0,o.jsx)(n.admonition,{type:"info",children:(0,o.jsx)(n.p,{children:"In the examples, we'll be using Nginx. However, you can use other reverse proxies."})}),"\n",(0,o.jsx)(n.h2,{id:"run-multiple-instances-of-rocketchat",children:"Run multiple instances of Rocket.Chat"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Configure Rocket.Chat to run as a systemd service. Since you want to run multiple instances simultaneously, you must run at least two services. The only difference is the service name and port. If you don't have a service yet, the easiest way to do this for Rocket.Chat is to create a file in ",(0,o.jsx)(n.code,{children:"/usr/lib/systemd/system/"})," and call it ",(0,o.jsx)(n.code,{children:"rocketchat.service"})]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"[Unit]\nDescription=Rocket.Chat Server\nAfter=syslog.target\nAfter=network.target\n\n[Service]\nType=simple\nRestart=always\nStandardOutput=syslog\nSyslogIdentifier=RocketChat\nUser=rocketchat\nGroup=rocketchat\nEnvironment=MONGO_URL=mongodb://your_mongodb:27017/your_database?replicaSet=your_replica_set_name\nEnvironment=MONGO_OPLOG_URL=mongodb://your_mongodb1:27017/local?replicaSet=your_replica_set_name\nEnvironment=ROOT_URL=https://your_rocketchat_domain.com\nEnvironment=PORT=3000\nWorkingDirectory=/path.to.rocketchat/rocket.chat\nExecStart=/usr/local/bin/node /path.to.rocketchat/rocket.chat/bundle/main.js\n\n[Install]\nWantedBy=multi-user.target\n"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Ensure the User and Group exist, and both have ",(0,o.jsx)(n.code,{children:"read/write/execute permissions"})," for ",(0,o.jsx)(n.code,{children:"rocketchat"}),". Now you can start, stop, restart, and see the status of your ",(0,o.jsx)(n.code,{children:"rocketchat"})," service. If you want multiple services, create another file in ",(0,o.jsx)(n.code,{children:"/usr/lib/systemd/system"})," and call it ",(0,o.jsx)(n.code,{children:"rocketchat@.service"})," updating the content with the these data:"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"[Unit]\nDescription=Rocket.Chat Server\nAfter=syslog.target\nAfter=network.target\n\n[Service]\nType=simple\nRestart=always\nStandardOutput=syslog\nSyslogIdentifier=RocketChat\nUser=rocketchat\nGroup=rocketchat\nEnvironment=MONGO_URL=mongodb://your_mongodb:27017/your_database?replicaSet=your_replica_set_name\nEnvironment=MONGO_OPLOG_URL=mongodb://your_mongodb1:27017/local?replicaSet=your_replica_set_name\nEnvironment=ROOT_URL=https://your_rocketchat_domain.com\nEnvironment=PORT=%I\nWorkingDirectory=/path.to.rocketchat/rocket.chat\nExecStart=/usr/local/bin/node /path.to.rocketchat/rocket.chat/bundle/main.js\n\n[Install]\n    WantedBy=multi-user.target\n"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Start the other Rocket.Chat services."}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:"systemctl start rocketchat@3001"})}),"\n",(0,o.jsx)(n.admonition,{type:"info",children:(0,o.jsxs)(n.p,{children:["You can use any desired port instead of ",(0,o.jsx)(n.code,{children:"3001"}),"."]})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"To run Rocket.Chat during boot; use the command below to enable the services:"}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:"systemctl enable rocketchat or systemctl enable rocketchat@3001"})}),"\n",(0,o.jsx)(n.h3,{id:"ensure-nodes-can-communicate",children:"Ensure nodes can communicate"}),"\n",(0,o.jsx)(n.p,{children:"If you run Rocket.Chat instances on multiple physical nodes or containers, ensure they can communicate with each other.  This means that instead of relying on a central server, the instances directly interact with one another. Rocket.Chat uses a peer-to-peer connection to inform each other of events. This becomes especially important when certain events occur that require cross-instance notification."}),"\n",(0,o.jsx)(n.p,{children:"For example, when you type a message and tag a friend or coworker connected to another instance. Two different events are fired; the user (you) is typing and notifying the user (friend)."}),"\n",(0,o.jsxs)(n.p,{children:["When you set up a Rocket.Chat instance, it registers its IP address in your database. Other instances use this list to discover each other and establish connections. If you are having trouble getting two instances to communicate, you can set the ",(0,o.jsx)(n.code,{children:"INSTANCE_IP"})," environment variable in the ",(0,o.jsx)(n.code,{children:".env"})," file to the IP address that the other instances can use to talk to it."]}),"\n",(0,o.jsx)(n.h2,{id:"update-your-nginx-proxy-config",children:"Update your Nginx proxy config"}),"\n",(0,o.jsxs)(n.p,{children:["Edit ",(0,o.jsx)(n.code,{children:"/etc/nginx/sites-enabled/default"})," or ",(0,o.jsx)(n.code,{children:"/etc/nginx/conf.d/default.conf"})," ( if you use nginx from docker) and replace the sample hostname ",(0,o.jsx)(n.code,{children:"your_hostname.com"})," with your actual hostname. You need to set up a backend if one doesn't already exist and add all local Rocket.Chat instances to it. Then swap out the host listed in the proxy section for the backend you defined with no port."]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Now, update the Nginx config to point to the two Rocket.Chat instances that started running on ports ",(0,o.jsx)(n.code,{children:"3001"})," and ",(0,o.jsx)(n.code,{children:"3002"}),"."]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:"# Upstreams\nupstream backend {\n    server 127.0.0.1:3000;\n    server 127.0.0.1:3001;\n    #server 127.0.0.1:3002;\n    #server 127.0.0.1:3003;\n    .\n    .\n    .\n}\n"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Replace ",(0,o.jsx)(n.code,{children:"proxy_pass http://IP:3000/;"})," with ",(0,o.jsx)(n.code,{children:"proxy_pass http://backend;"}),". Updating the ",(0,o.jsx)(n.a,{href:"https://docs.rocket.chat/installation/manual-installation/configuring-ssl-reverse-proxy#running-behind-a-nginx-ssl-reverse-proxy",children:"sample Nginx configuration"})," would result in a config like this:"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"    apacheconf\n    # HTTPS Server\nserver {\n    listen 443;\n    server_name your_hostname.com;\n\n    error_log /var/log/nginx/rocketchat.access.log;\n\n    ssl on;\n    ssl_certificate /etc/nginx/certificate.crt;\n    ssl_certificate_key /etc/nginx/certificate.key;\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2; # don\u2019t use SSLv3 ref: POODLE\n\n    location / {\n        proxy_pass http://backend;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection upgrade;\n        proxy_set_header Host $http_host;\n\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto https;\n        proxy_set_header X-Nginx-Proxy true;\n\n        proxy_redirect off;\n        client_max_body_size 0;\n    }\n}\n"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Restart Nginx."}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:"service nginx restart"})}),"\n",(0,o.jsx)(n.h2,{id:"update-your-apache-proxy-config",children:"Update your Apache proxy config"}),"\n",(0,o.jsx)(n.p,{children:"Run this as a root user to enable the necessary modules to use the proxy balancer."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"a2enmod proxy_html\na2enmod proxy_balancer\na2enmod headers\na2enmod session\na2enmod session_cookie\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Edit ",(0,o.jsx)(n.code,{children:"/etc/apache2/sites-enabled/rocketchat.conf"})," and confirm that your hostname has been updated."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-apacheconf",children:"<VirtualHost *:443>\n    ServerAdmin it@domain.com\n    ServerName chat.domain.com\n\n    LogLevel info\n    ErrorLog /var/log/chat.domain.com_error.log\n    TransferLog /var/log/chat.domain.com_access.log\n\n    SSLEngine On\n    SSLCertificateFile /etc/ssl/certs/chat.domain.com.crt\n    SSLCertificateKeyFile /etc/ssl/private/chat.domain.com.key\n\n    ProxyPreserveHost On\n\n    <Proxy balancer://http>\n        BalancerMember http://localhost:3000 route=1\n        BalancerMember http://localhost:3001 route=2\n        ...\n        ProxySet stickysession=ROUTEID\n    </Proxy>\n\n    <Proxy balancer://ws>\n        BalancerMember ws://localhost:3000 route=1\n        BalancerMember ws://localhost:3001 route=2\n        ...\n        ProxySet stickysession=ROUTEID\n    </Proxy>\n\n    <Location />\n        Require all granted\n    </Location>\n\n    RewriteEngine On\n    RewriteCond %{HTTP:Upgrade} =websocket [NC]\n    RewriteRule /(.*)           balancer://ws/$1 [P,L]\n    RewriteCond %{HTTP:Upgrade} !=websocket [NC]\n    RewriteRule /(.*)           balancer://http/$1 [P,L]\n\n    ProxyPassReverse /          http://localhost/\n</VirtualHost>\n"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Restart Apache."}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:"systemctl restart apache2.service"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Visit ",(0,o.jsx)(n.code,{children:"https://your_hostname.com"})," and confirm the updates."]}),"\n"]}),"\n",(0,o.jsx)(n.admonition,{type:"info",children:(0,o.jsx)(n.p,{children:"To prove you're using both services as you'd expect, you can stop one Rocket.Chat service at a time and ensure that the chat still works. Restart that service and stop the other. That will show you are using both instances. Be sure to maintain time in sync between all instances."})}),"\n",(0,o.jsx)(n.h2,{id:"check-your-database",children:"Check your database"}),"\n",(0,o.jsx)(n.p,{children:"The database is another vital part of this setup. First, you must ensure you are running a replicaset. It is essential due to the following reasons:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Database reliability:"})," Confirm that your data is replicated and you have another node if something happens to your primary."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Oplog Tailing"}),": The oplog is turned on when you set up a replicaset. Mongo uses this to publish events so the other nodes in the replicaset can ensure its data is updated. Rocket.Chat uses this to watch for database events. If someone sends a message on Instance 1 and you are connected to Instance 2. Instance 2 watches for message insert events, showing you a new message has arrived."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},11151:(e,n,t)=>{t.d(n,{Z:()=>i,a:()=>a});var o=t(67294);const r={},s=o.createContext(r);function a(e){const n=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),o.createElement(s.Provider,{value:n},e.children)}}}]);