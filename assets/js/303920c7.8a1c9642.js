"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[56018],{22375:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>d,frontMatter:()=>r,metadata:()=>o,toc:()=>h});var i=t(85893),s=t(11151);const r={},a="Configure without previously having a PBX server",o={id:"use-rocket.chat/rocket.chat-voice-channel/voice-channel-admin-guide/configure-without-previously-having-a-pbx-server/README",title:"Configure without previously having a PBX server",description:"PBX is an architecture that forwards incoming calls from telephony service providers to Rocket.Chat. It is used for call bookkeeping, which includes information such as the number of queues, extension data, agent allocation to a queue, and routing system.",source:"@site/docs/use-rocket.chat/rocket.chat-voice-channel/voice-channel-admin-guide/configure-without-previously-having-a-pbx-server/README.md",sourceDirName:"use-rocket.chat/rocket.chat-voice-channel/voice-channel-admin-guide/configure-without-previously-having-a-pbx-server",slug:"/use-rocket.chat/rocket.chat-voice-channel/voice-channel-admin-guide/configure-without-previously-having-a-pbx-server/",permalink:"/docs-exp/docs/use-rocket.chat/rocket.chat-voice-channel/voice-channel-admin-guide/configure-without-previously-having-a-pbx-server/",draft:!1,unlisted:!1,editUrl:"https://github.com/Freedom101/docs-exp/tree/main/my-website/docs/use-rocket.chat/rocket.chat-voice-channel/voice-channel-admin-guide/configure-without-previously-having-a-pbx-server/README.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Associate agents with extensions in Rocket.Chat",permalink:"/docs-exp/docs/use-rocket.chat/rocket.chat-voice-channel/voice-channel-admin-guide/configure-with-an-active-pbx-server/associate-agents-with-extensions-in-rocket.chat"},next:{title:"Configure asterisk manager interface and users",permalink:"/docs-exp/docs/use-rocket.chat/rocket.chat-voice-channel/voice-channel-admin-guide/configure-without-previously-having-a-pbx-server/configure-asterisk-manager-interface-and-users"}},c={},h=[{value:"1. Prepare FreePBX",id:"1-prepare-freepbx",level:2},{value:"2. Configure the FreePBX firewall",id:"2-configure-the-freepbx-firewall",level:2},{value:"2.1 Configure custom services AMI and WSS",id:"21-configure-custom-services-ami-and-wss",level:3},{value:"<strong>2.2 Whitelist Rocket.Chat</strong>",id:"22-whitelist-rocketchat",level:3},{value:"3. Configure SSL",id:"3-configure-ssl",level:2},{value:"4. Configure Asterisk to use PJSIP as the main (or only) SIP channel",id:"4-configure-asterisk-to-use-pjsip-as-the-main-or-only-sip-channel",level:2},{value:"5. Configure Asterisk HTTP/WebSocket features",id:"5-configure-asterisk-httpwebsocket-features",level:2},{value:"5.1 Enable Asterisk\u2019s WebSocket and mini-HTTP",id:"51-enable-asterisks-websocket-and-mini-http",level:3},{value:"5.2 Enable the WS and WSS SIP transports",id:"52-enable-the-ws-and-wss-sip-transports",level:3},{value:"5.3 Test Asterisk HTTP mini-server",id:"53-test-asterisk-http-mini-server",level:3}];function l(e){const n={a:"a",admonition:"admonition",br:"br",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",p:"p",pre:"pre",strong:"strong",...(0,s.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"configure-without-previously-having-a-pbx-server",children:"Configure without previously having a PBX server"}),"\n",(0,i.jsx)(n.p,{children:"PBX is an architecture that forwards incoming calls from telephony service providers to Rocket.Chat. It is used for call bookkeeping, which includes information such as the number of queues, extension data, agent allocation to a queue, and routing system."}),"\n",(0,i.jsxs)(n.p,{children:["For the purpose of this guide, we'll be using ",(0,i.jsx)(n.a,{href:"https://www.freepbx.org/",children:"FreePBX"})," as the call management server. You can use any Asterisk distro of your choice."]}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsxs)(n.p,{children:["Before you proceed, see ",(0,i.jsx)(n.a,{href:"/docs-exp/docs/use-rocket.chat/rocket.chat-voice-channel/getting-started-with-voice-channel",title:"mention",children:"getting-started-with-voice-channel.md"})," to view all the necessary requirements."]})}),"\n",(0,i.jsx)(n.h2,{id:"1-prepare-freepbx",children:"1. Prepare FreePBX"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.br,{}),"\n","Install your FreePBX server, as usual (that\u2019s out of the scope of this tutorial), and update it using your OS package manager. In such a case, it\u2019s:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"yum update -y\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Enter your server web interface ",(0,i.jsx)(n.code,{children:"http://your.domain.name"})," and set the password and update settings, and do the activation process. Do not skip the activation process, as you\u2019ll need some features later that are only available if you activate your server instance. Complete the firewall basic configuration."]}),"\n",(0,i.jsx)(n.h2,{id:"2-configure-the-freepbx-firewall",children:"2. Configure the FreePBX firewall"}),"\n",(0,i.jsx)(n.p,{children:"Now you need to prepare the FreePBX firewall to accept AMI (Asterisk Manager Interface) and WSS (WebSocket Secure)."}),"\n",(0,i.jsx)(n.h3,{id:"21-configure-custom-services-ami-and-wss",children:"2.1 Configure custom services AMI and WSS"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.br,{}),"\n","Navigate to ",(0,i.jsx)(n.strong,{children:"Connectivity > Firewall > Services > Enable Firewall"}),". Under the Services tab, search for ",(0,i.jsx)(n.strong,{children:"WebRTC"})," and mark ",(0,i.jsx)(n.strong,{children:"Internet"})," and ",(0,i.jsx)(n.strong,{children:"Other"})," options, ",(0,i.jsx)(n.strong,{children:"Local"})," is active by default."]}),"\n",(0,i.jsx)(n.p,{children:"![Firewall - services](/img/image (679).png)"}),"\n",(0,i.jsxs)(n.p,{children:["We want ",(0,i.jsx)(n.strong,{children:"WebRTC"})," in the Internet zone because the Webphone will connect from the client\u2019s IP address, which could be anywhere."]}),"\n",(0,i.jsxs)(n.p,{children:["Navigate to the ",(0,i.jsx)(n.strong,{children:"Custom Services"})," tab and hit the ",(0,i.jsx)(n.strong,{children:"Create new service"}),", name the service AMI, select TCP, and write the port range 5038:5039. Click ",(0,i.jsx)(n.strong,{children:"Save"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"![Create new service](/img/image (905).png)"}),"\n",(0,i.jsxs)(n.p,{children:["Mark the ",(0,i.jsx)(n.strong,{children:"Other"})," option and ",(0,i.jsx)(n.strong,{children:"Save"}),"."]}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsx)(n.p,{children:"AMI goes in the \u201cOther\u201d zone because only some specific endpoints should be connecting to AMI."})}),"\n",(0,i.jsx)(n.p,{children:"![AMI service](/img/image (681).png)"}),"\n",(0,i.jsx)(n.h3,{id:"22-whitelist-rocketchat",children:(0,i.jsx)(n.strong,{children:"2.2 Whitelist Rocket.Chat"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.br,{}),"\n","Now you don\u2019t want your Rocket.Chat to get banned by the FreePBX firewall so you have to add it to the Whitelist List. First, you need to know the IP or IP Networks from your Rocket.Chat instance. When you have a SaaS Rocket.Chat instance you will have a URL (subdomain) like ",(0,i.jsx)("mark",{style:{color:"blue"},children:"MyChosenName.rocket.chat"}),", so just ping it. In this demo:"]}),"\n",(0,i.jsx)(n.p,{children:"![](/img/image (48).png)"}),"\n",(0,i.jsxs)(n.p,{children:["Rocket.Chat will be connecting from the whole network 51.81.0.0/16",(0,i.jsx)(n.br,{}),"\n","If you have your own Rocket.Chat instance self-hosted or similar, you should know what\u2019s your IP address or network."]}),"\n",(0,i.jsxs)(n.p,{children:["Now, navigate to ",(0,i.jsx)(n.strong,{children:"Connectivity > Firewall >"})," ",(0,i.jsx)(n.strong,{children:"Networks"}),", and add the IP address needed or Network. Select the ",(0,i.jsx)(n.strong,{children:"Other"})," zone and ",(0,i.jsx)(n.strong,{children:"Save"}),":"]}),"\n",(0,i.jsx)(n.p,{children:"![Network definitions](/img/image (88).png)"}),"\n",(0,i.jsxs)(n.p,{children:["Rocket.Chat will be in the ",(0,i.jsx)(n.strong,{children:"Other"})," zone."]}),"\n",(0,i.jsx)(n.h2,{id:"3-configure-ssl",children:"3. Configure SSL"}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsx)(n.p,{children:"We used Letsencrypt for this demo."})}),"\n",(0,i.jsx)(n.p,{children:"This will only work if you have your FreePBX already activated."}),"\n",(0,i.jsxs)(n.p,{children:["Navigate to ",(0,i.jsx)(n.strong,{children:"Admin > Port Management"}),". Change the Admin (web portal) to another port and set Letsencrypt to port 80. Click ",(0,i.jsx)(n.strong,{children:"Update"})," ",(0,i.jsx)(n.strong,{children:"Now"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"![Port management](/img/image (602).png)"}),"\n",(0,i.jsx)(n.p,{children:"Please note that until here, you have been accessing the server by HTTP (not HTTPS) on port 80. Until you finish the SSL configuration, you are going to be using the newly selected port, 8080, in this demo."}),"\n",(0,i.jsxs)(n.p,{children:["Now navigate to ",(0,i.jsx)(n.strong,{children:"Admin > Certificate Management"}),", and click on ",(0,i.jsx)(n.strong,{children:"New Certificate"})," > ",(0,i.jsx)(n.strong,{children:"Generate Let\u2019s Encrypt Certificate"}),":"]}),"\n",(0,i.jsx)(n.p,{children:"![Certificate management](/img/image (603).png)"}),"\n",(0,i.jsxs)(n.p,{children:["Fill out the form according to your settings and click ",(0,i.jsx)(n.strong,{children:"Generate Certificate"}),":"]}),"\n",(0,i.jsx)(n.p,{children:"![Generate certificate](/img/image (1173).png)"}),"\n",(0,i.jsx)(n.p,{children:"Once it\u2019s generated, mark it as the system\u2019s default:"}),"\n",(0,i.jsx)(n.p,{children:"![Default certificate](/img/image (1053).png)"}),"\n",(0,i.jsxs)(n.p,{children:["Now you can start using it. Go to the ",(0,i.jsx)(n.strong,{children:"Admin > System Admin > HTTPS Setup"})," and then to the ",(0,i.jsx)(n.strong,{children:"Settings"})," tab. Here select the certificate that was just generated and click on ",(0,i.jsx)(n.strong,{children:"Install"}),", wait, then select the Protocols TLS 1.2 and 1.3 as others are considered deprecated or insecure:"]}),"\n",(0,i.jsx)(n.p,{children:"![HTTPS setup](/img/image (938).png)"}),"\n",(0,i.jsxs)(n.p,{children:["Finally, click on ",(0,i.jsx)(n.strong,{children:"Save and Restart Apache"})," (A server restart is suggested here). Test in incognito that the changes are applied and the certificate is recognized as valid."]}),"\n",(0,i.jsxs)(n.p,{children:["Additionally, you can go back to the ",(0,i.jsx)(n.strong,{children:"Admin > System Admin > Port Management"})," to enforce HTTPS, select your FQDN and select the force (arrow) button from HTTP (8080) to HTTPS (443), then click hit ",(0,i.jsx)(n.strong,{children:"Save"}),":"]}),"\n",(0,i.jsx)(n.p,{children:"![](/img/image (953).png)"}),"\n",(0,i.jsx)(n.p,{children:"Test it. Congratulations! you have an HTTPS-valid SSL FreePBX server up and running."}),"\n",(0,i.jsx)(n.h2,{id:"4-configure-asterisk-to-use-pjsip-as-the-main-or-only-sip-channel",children:"4. Configure Asterisk to use PJSIP as the main (or only) SIP channel"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.br,{}),"\n","We are using chan_pjsip as the only SIP driver. Go to ",(0,i.jsx)(n.strong,{children:"Settings > Advanced"})," ",(0,i.jsx)(n.strong,{children:"Settings"}),", search for ",(0,i.jsx)(n.strong,{children:"SIP Channel Driver"}),", and choose ",(0,i.jsx)(n.strong,{children:"chan_pjsip"}),". Hit ",(0,i.jsx)(n.strong,{children:"Submit"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"![PJSIP](/img/image (790).png)"}),"\n",(0,i.jsx)(n.h2,{id:"5-configure-asterisk-httpwebsocket-features",children:"5. Configure Asterisk HTTP/WebSocket features"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.br,{}),"\n","Using the article ",(0,i.jsx)(n.a,{href:"https://wiki.asterisk.org/wiki/display/AST/Configuring+Asterisk+for+WebRTC+Clients",children:"Configuring Asterisk for WebRTC Clients 1"})," in Asterisk\u2019s Wiki, we are going only for the principal parameters if you need more details, the article is a great guide.\\"]}),"\n",(0,i.jsx)(n.h3,{id:"51-enable-asterisks-websocket-and-mini-http",children:"5.1 Enable Asterisk\u2019s WebSocket and mini-HTTP"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.br,{}),"\n","First, check that you have the needed modules loaded using the command ",(0,i.jsx)(n.code,{children:"module show like <module_name>"})]}),"\n",(0,i.jsx)(n.p,{children:"![Modules](/img/image (1171).png)"}),"\n",(0,i.jsxs)(n.p,{children:["We are reusing the Let\u2019s Encrypt certificates for the Asterisk mini-HTTP server, WebSockets, TLS encryption, and others. Start by going to ",(0,i.jsx)(n.strong,{children:"Settings > Advanced Settings"})," (again), search for the ",(0,i.jsx)(n.em,{children:"Asterisk Builtin mini-HTTP server"})," section and, configure as shown, apply changes. Asterisk restart is also recommended here:"]}),"\n",(0,i.jsx)(n.p,{children:"![Asterisk Builtin mini-HTTP server](/img/image (1006).png)"}),"\n",(0,i.jsxs)(n.p,{children:["Using the command ",(0,i.jsx)(n.code,{children:"http show status"})," verify that both HTTP and HTTPS are up and running:"]}),"\n",(0,i.jsx)(n.p,{children:"![HTTP and HTTPS status](/img/image (806).png)"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"If HTTP does but HTTPS doesn\u2019t check that Asterisk can read the certificate and private key files:"})," Add capture of file reading error."]}),"\n",(0,i.jsx)(n.h3,{id:"52-enable-the-ws-and-wss-sip-transports",children:"5.2 Enable the WS and WSS SIP transports"}),"\n",(0,i.jsxs)(n.p,{children:["Navigate to ",(0,i.jsx)(n.strong,{children:"Settings > Asterisk SIP Settings"}),". In the ",(0,i.jsx)(n.strong,{children:"General SIP Settings"})," tab configure your audio codecs, enable video, and select video codecs (vp8 and vp9 needed for WebRTC), NAT, etc. Then in the ",(0,i.jsx)(n.strong,{children:"SIP Settings"})," (chan_pjsip) tab, choose your valid SSL certificate for ",(0,i.jsx)(n.strong,{children:"TLS/SSL/SRTP"})," and enable all the desired transports, especially WS and WSS:"]}),"\n",(0,i.jsx)(n.p,{children:"![SIP transports](/img/image (1281).png)"}),"\n",(0,i.jsx)(n.p,{children:"Click submit and apply changes (an Asterisk restart is recommended)"}),"\n",(0,i.jsx)(n.h3,{id:"53-test-asterisk-http-mini-server",children:"5.3 Test Asterisk HTTP mini-server"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.br,{}),"\n","Navigate to ",(0,i.jsx)(n.code,{children:"https://mysub.domainname.domain:8089/httpstatus"})," and verify that it loads, SSL Port is present, and the SSL certificate is valid:"]}),"\n",(0,i.jsx)(n.p,{children:"![Asterisk status](/img/image (1157).png)"}),"\n",(0,i.jsx)(n.p,{children:"Congratulations! You have a valid SSL Asterisk WebRTC-ready server up and running."})]})}function d(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},11151:(e,n,t)=>{t.d(n,{Z:()=>o,a:()=>a});var i=t(67294);const s={},r=i.createContext(s);function a(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);